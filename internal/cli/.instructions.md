# Copilot Instructions for the nixai Project

## Project Purpose
- nixai is a console-based Linux application for solving NixOS configuration problems and assisting with NixOS setup and management from the command line.
- It supports direct AI-powered help via `nixai "question"` or `nixai --ask "question"`.
- It uses LLMs (Ollama, Gemini, OpenAI, etc.), preferring local Ollama models for privacy, but supporting cloud providers as fallback.
- It integrates an MCP server for querying NixOS documentation from multiple sources.
- It can parse and analyze logs, accept piped log input, execute local commands, and diagnose issues interactively or via CLI.

## Coding Guidelines

- **Go idioms:** Write idiomatic, modular, and well-documented Go code.
- **Configuration:** Load all configuration from YAML (`configs/default.yaml`) using the `internal/config` package.
- **AI Integration:** Use the `internal/ai` package for all LLM interactions. Support multiple providers and allow user selection.
- **Documentation Queries:** Use the `internal/mcp` package for all documentation queries, always using sources defined in config.
- **System Operations:** Use the `internal/nixos` package for log parsing, diagnostics, and command execution.
- **Logging:** Use the `pkg/logger` package for all logging, respecting the log level from config.
- **Utilities:** Use the `pkg/utils` package for utility functions (file checks, string helpers, formatting, etc.).
- **CLI Logic:** All CLI commands and interactive logic must be in the `internal/cli` package, using the cobra framework.
- **Entrypoint:** The main entrypoint is `cmd/nixai/main.go`.

## Features to Support

- **Direct Question Assistant:** Support answering questions via `nixai "question"` or `nixai --ask "question"`.
- **Diagnose NixOS Issues:** Use LLMs to diagnose NixOS configuration and log issues.
- **Documentation Queries:** Query NixOS documentation from:
  - https://wiki.nixos.org/wiki/NixOS_Wiki
  - https://nix.dev/manual/nix
  - https://nixos.org/manual/nixpkgs/stable/
  - https://nix.dev/manual/nix/2.28/language/
  - https://nix-community.github.io/home-manager/
- **System Commands:** Execute and parse local NixOS commands.
- **Log Input:** Accept log input via pipe or file.
- **AI Provider Selection:** Allow user to select/configure AI provider (Ollama, Gemini, OpenAI, etc.).
- **Package Repository Analysis:** Analyze Git repos and generate Nix derivations with the `package-repo` command.
- **NixOS Option Explainer:** Explain NixOS options with the `explain-option` command.
- **Home Manager Option Support:** Explain Home Manager options with `explain-home-option`.
- **Community Resources:** Show NixOS community resources with the `community` command.
- **Other Commands:** Implement and document commands such as `logs`, `mcp-server`, `neovim-setup`, `flake`, and `learn`.
- **Testability:** All new features must be testable and documented.

## CLI Command Guidelines

- Use the cobra framework for all CLI commands.
- Follow the `cmd/subcommand/action` structure.
- Each command must have proper help text, examples, and flag descriptions.
- Use consistent flag names (e.g., `--nixos-path`, `--dry-run`, `--verbose`).
- Use `utils.FormatHeader`, `utils.FormatKeyValue`, `utils.FormatDivider`, and other formatting utilities for output.
- Use glamour for Markdown rendering with proper syntax highlighting.
- Show progress indicators for API calls and long-running operations.
- Use emojis for visual appeal and section headers.
- Provide actionable error messages using `utils.FormatError`.
- Validate and sanitize all user input and log data.
- Gracefully handle EOF, interrupts, and unavailable services (AI, MCP, etc.).
- Support both CLI and interactive mode for all commands.

## Testing & Build

- Use the `justfile` for build, test, lint, and run tasks.
- Use Nix (`flake.nix`) for reproducible builds and dev environments.
- All new features must include corresponding test files:
  - Unit tests: `*_test.go`
  - Integration tests: `*_integration_test.go`
  - Interactive mode tests: `interactive_test.go`
- Mock external dependencies (AI providers, MCP server, file system) in tests.
- Test both CLI and interactive mode functionality.
- Aim for comprehensive test coverage.

## Documentation

- Update `README.md` and `docs/MANUAL.md` for new features or changes.
- Document both direct question and flag-based question interfaces.
- Include examples for all features in both the README and manual.
- Keep this instruction file up to date as the project evolves.

## AI Provider Integration

- All AI providers (Ollama, Gemini, OpenAI) must implement both `Query` and `GenerateResponse` methods.
- Default to Ollama with the "llama3" model if no provider is configured.
- Format prompts consistently across all providers.
- Keep API keys in environment variables, not in config files.

## Terminal UI

- Use formatting utilities for headers, key-value pairs, and dividers.
- Use glamour for Markdown rendering.
- Show progress indicators for long operations.
- Use consistent terminology and helpful examples in command help.

## Code Organization

```
internal/cli/
├── commands.go                              # Main command implementations
├── interactive.go                           # Interactive mode logic
├── common_helpers.go                        # Common CLI helpers
├── build_commands.go                        # Build-related commands
├── deps_commands.go                         # Dependency commands
├── devenv_commands.go                       # Development environment commands
├── gc_commands.go                           # Garbage collection commands
├── hardware_commands.go                     # Hardware detection commands
├── migration_commands.go                    # Migration commands
├── template_commands.go                     # Template management commands
├── *_test.go                                # Test files for each command module
├── commands_explain_option_integration_test.go  # Integration tests
└── interactive_test.go                      # Interactive mode tests
```

## Best Practices

1. **Consistency:** Follow existing patterns for command structure and naming.
2. **Documentation:** Include comprehensive help text and examples.
3. **Error Handling:** Provide actionable error messages.
4. **Progress Feedback:** Show progress for operations that take time.
5. **Graceful Degradation:** Handle missing dependencies gracefully.
6. **Security:** Validate and sanitize all user input.
7. **Testing:** Write comprehensive tests for all command functionality.
8. **Accessibility:** Use clear, readable output formatting.

## Integration Points

- **AI Providers:** Use `internal/ai` for all AI interactions.
- **Configuration:** Use `internal/config` for configuration management.
- **NixOS Integration:** Use `internal/nixos` for system operations.
- **MCP Server:** Use `internal/mcp` for documentation queries.
- **Logging:** Use `pkg/logger` for all logging operations.
- **Utilities:** Use `pkg/utils` for common operations.

---

> These instructions are for all Copilot models and contributors. Follow them to ensure consistency, maintainability, and feature completeness for the nixai project.